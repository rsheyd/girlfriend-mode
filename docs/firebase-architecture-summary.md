# Firebase Realtime Database Architecture for Scrabble Game

## Overview
The Scrabble game uses Firebase Realtime Database (RTDB) to store game state, enabling real-time multiplayer functionality. The database is organized hierarchically with games as the primary entity.

## Database Structure

### Root Level
```
games/
  {gameId}/
```

### Game Document Structure
Each game is stored under `games/{gameId}` with the following structure:

```json
{
  "status": "waiting" | "active" | "finished",
  "player1Uid": "firebase_user_id_1",
  "player2Uid": "firebase_user_id_2" | null,
  "activePlayerUid": "firebase_user_id_current_turn",
  "bag": [
    {"id": "t1", "letter": "A", "value": 1},
    {"id": "t2", "letter": "B", "value": 3},
    // ... remaining tiles in bag
  ],
  "racks": {
    "firebase_user_id_1": [
      {"id": "t5", "letter": "S", "value": 1},
      // ... 7 tiles for player 1
    ],
    "firebase_user_id_2": [
      {"id": "t12", "letter": "C", "value": 3},
      // ... 7 tiles for player 2
    ]
  },
  "board": {
    "tiles": [
      [null, null, {"id": "t20", "letter": "H", "value": 4}, ...],
      // 15x15 grid, null for empty squares
      // Each non-null entry contains tile data
    ],
    "multipliers": [
      ["TW", null, null, "DL", ...],
      // 15x15 grid of multiplier types: "TW", "DW", "TL", "DL", or null
    ]
  },
  "moves": [
    {
      "id": "move_1",
      "playerUid": "firebase_user_id_1",
      "timestamp": 1640995200000,
      "type": "place_tiles",
      "tiles": [
        {"tileId": "t5", "row": 7, "col": 7, "letter": "H"},
        {"tileId": "t6", "row": 7, "col": 8, "letter": "E"}
      ],
      "word": "HE",
      "score": 8
    },
    // ... chronological list of all moves
  ],
  "scores": {
    "firebase_user_id_1": 45,
    "firebase_user_id_2": 32
  },
  "updatedAt": 1640995200000
}
```

## Key Components

### Game ID
- Auto-generated by Firebase using `push()` when creating new games
- Used as the primary key for game lookup and real-time subscriptions

### Board
- **Tiles Grid**: 15x15 array representing placed tiles on the board
- **Multipliers Grid**: Static 15x15 array defining bonus squares (TW/DW/TL/DL)
- **Updates**: Modified when players place tiles during their turn

### Moves
- **Chronological Array**: Each move contains tile placements, scores, and metadata
- **Validation**: Moves are validated client-side before being committed to RTDB
- **Real-time**: New moves trigger UI updates for all players via RTDB listeners

## App Update Patterns

### Game Creation
1. Player creates game via `createGame()` function
2. Firebase generates gameId and stores initial game state
3. Player navigates to game URL with gameId

### Real-time Synchronization
1. **Board Updates**: Listen to `games/{gameId}/board` for tile placements
2. **Turn Management**: Monitor `games/{gameId}/activePlayerUid` for turn changes
3. **Rack Updates**: Subscribe to `games/{gameId}/racks/{userId}` for tile draws
4. **Move History**: Watch `games/{gameId}/moves` array for new moves

### Move Execution Flow
1. Player selects tiles from rack and positions on board
2. Client validates move (word formation, tile availability, etc.)
3. Update RTDB:
   - Add move to `moves` array
   - Update `board.tiles` with new placements
   - Update player scores in `scores`
   - Switch `activePlayerUid` to next player
   - Draw new tiles to player's rack from `bag`
   - Update `updatedAt` timestamp

### Real-time Listeners
```typescript
// Example: Listen for board changes
const boardRef = ref(db, `games/${gameId}/board`);
onValue(boardRef, (snapshot) => {
  const board = snapshot.val();
  // Update UI with new board state
});

// Example: Listen for moves
const movesRef = ref(db, `games/${gameId}/moves`);
onChildAdded(movesRef, (snapshot) => {
  const newMove = snapshot.val();
  // Add move to UI move history
});
```

## Security Considerations
- RTDB rules should ensure players can only modify their own games
- Validate moves server-side if possible (or rely on client validation + game state consistency)
- Use Firebase Auth UIDs for player identification

## Future Enhancements
- Add game chat under `games/{gameId}/chat`
- Store game statistics under user profiles
- Implement game invitations and matchmaking